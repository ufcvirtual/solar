#items
  = f.nested_fields_for :question_items, wrapper_tag: :div do |i|
    .duplicatable_nested_form
      = i.remove_nested_fields_link content_tag(:i, nil, class: 'icon-trash', :'data-tooltip' => t('questions.form.items.remove'))
      = link_to_function content_tag(:i, nil, class: 'icon-comment'), 'add_comment(this)', class: 'comment', :'data-tooltip' => t('questions.form.items.comments')
      = link_to_function content_tag(:i, nil, class: 'icon-pictures'), 'add_image(this)', class: 'image_icon', :'data-tooltip' => t('questions.form.items.images')
      .inline
        .inputs
          = i.check_box :value
          = i.select :value, ([ ['V', true], ['F', false]]), include_blank: false
          .obs= t('questions.form.items.choose_correct')
        .label= i.label :description
        .desc
          = i.input :description, label: false, class: 'ckeditor'
        .comment_area{ class: i.object.comment.blank? ? 'hide' : '' }
          = i.input :comment, as: :text, label: t('questions.form.items.comment')
        .image.hide
          .upload-preview
            - if i.object.item_image_file_name.blank?
              %img{ src: '' }
            - else
              %img{ src: i.object.item_image.as_json, id: 'image_item' }
            = i.input :item_image, as: :file, label: false
            - if i.object.item_image_file_name
              = link_to_function (t('questions.form.items.remove_image')), 'remove_image_item(this)', class: "btn btn_main remove", :'data-url' => remove_image_item_exam_question_path(i.object, exam_question_id: @exam_question.id)
            = link_to_function t('questions.form.items.add_image'), 'add_file(this)', class: 'btn btn_main add_file'
            
          .info
            = i.input :img_alt, label: t('questions.form.items.alt')
            = i.label t('questions.form.items.alt_desc'), class: 'alt'

= javascript_include_tag 'ckeditor/init', 'tooltip'

:javascript
  $(function(){
    CKEDITOR_BASEPATH = "#{request.env['RAILS_RELATIVE_URL_ROOT']}/assets/ckeditor/";

    CKEDITOR.editorConfig = function (config) {
      config.toolbar =
        [
          { name: 'clipboard', items : [ 'Copy', 'Paste', 'PasteText', '-', 'Undo', 'Redo' ] },
          { name: 'insert', items : ['EqnEditor'] },
          { name: 'basicstyles', items : [ 'Bold', 'Italic', 'Underline', 'Strike', '-', 'RemoveFormat' ] },
          { name: 'paragraph', items : [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent' ] }
        ];

        config.extraPlugins = 'eqneditor,oembed';
        config.resize_enabled = false;
        config.height = '80px';
        config.width = '500px';
    };

    $("#items").on("fields_added.nested_form_fields", function(event) {
      change_inputs();
    });

    $('#items .duplicatable_nested_form').each(function(idx) {
      var id = $('[id*="_question_items_attributes_'+idx+'_description"]:first').attr('id');
      append_rich_text(id);
    });

    set_image_input();
  });

  function add_comment(btn){
    $(btn).parents('.duplicatable_nested_form:first').find('.comment_area').fadeToggle(function(){
      if ($(this).is(':visible'))
        $(this).css('display','inline-block');
      $(this).toggleClass('hide');
    });
  }

  function remove_image_item(link){
    $.put($(link).data('url'), function(data){
      var success = data.success;
      flash_message(data.notice, 'notice');

      $(link).hide();
      $('#image_item').attr('src','');
      
    }).error(function(data){
      var response = $.parseJSON(data.responseText);
      if (typeof(response.alert) != "undefined")
       flash_message(response.alert, 'alert');
    });
  }

  function add_image(btn){
    $(btn).parents('.duplicatable_nested_form:first').find('.image').fadeToggle(function(){
      if ($(this).is(':visible'))
        $(this).css('display','inline-block');
      $(this).toggleClass('hide');
    });
  }

  