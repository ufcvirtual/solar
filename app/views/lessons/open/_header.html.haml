.titlebar#lesson_header
  .inline
    .breadcrumb
      = render 'lessons/open/breadcrumb'
  - if can?(:change_status, @lesson) || current_user.admin?
    .lesson_status
      %span.draft{ class: @lesson.is_draft? ? '' : 'invisible' }
        = image_tag 'rejected.png', :'aria-hidden' => 'true'
        %span.type= t('lessons.index.draft')
      %span.released{ class: @lesson.is_draft? ? 'invisible' : '' }
        = image_tag 'released.png', :'aria-hidden' => 'true'
        %span.type= t('lessons.index.released')

= javascript_include_tag 'lessons', 'audios'

:javascript

  var get_lesson_url = "#{lesson_url('lesson_id')}";
  var get_module_lessons_url = "#{open_module_lessons_path('lesson_module_id', allocation_tags_ids: 'allocation_tags_ids_value')}";
  var array_topicos = new Array();
  var lesson_text;
  var array_topicos_missing = new Array();

  $(function(){
    setTimeout(function() {
      var audio = document.querySelector('audio');
      audio.controlsList.remove('nodownload');

      let menu = $("#content_lesson").contents().find("md-sidenav").find(".navigation").last();
      menu.find("li").each(function(i, li) {
        array_topicos.push(new Array($(li).text().trim()));
      });
      load_text();
      $("#content_lesson").contents().find("#root").on('click', function(e) {
        setTimeout(function () {
          load_text();
        },1000); 
      });
    },3000);

    function load_text(){
      let topico = $("#content_lesson").contents().find("#content").text().trim();
      let texto = $("#content_lesson").contents().find(".white-paper").text().replace(/\s{2,}/g,' ');
      texto = texto.replace(/\r?\n|\r/g,'').replace(/\s{2,}/g,' ');
      for (var i in array_topicos) {
        //verifica se o texto pertence ao t√≥pico
        if(array_topicos[i][0]==topico){ 
          array_topicos[i][1] = texto;
          let idx = array_topicos_missing.indexOf(topico)
          if(idx != -1){
            delete array_topicos_missing[idx];
            array_topicos_missing = array_topicos_missing.filter(Boolean); 
          }
        }
      }
    }