function enroll_tables_with_no_data() {
  $('.table_ucs').each(function(){
    var rowCount = $('tbody>tr:visible', $(this)).length;
    if (rowCount == 0){
      $('.empty_message', $(this).closest('.block_content')).removeClass('hide_message');
      $('.thead_ucs', $(this)).hide();
    } else {
      $('.thead_ucs', $(this)).show();
      $('.empty_message', $(this).closest('.block_content')).addClass('hide_message');
    }
  });
}

function enroll_combo_change(event, ui) {
  // verifica UC
  var uc_class = $("#curriculum_unit option:selected").text().replace(/\W/g, '');
  var uc_type_class = $("#type option:selected").text().replace(/\W/g, '');
  var check_class = '';

  if (uc_class != '') // informou uc
    check_class += '.uc-' + uc_class;

  if (uc_type_class != '') // informou uc type
    check_class += '.uc-type-' + uc_type_class;

  $('tbody tr').show(); // show all

  if (check_class != '')
    $('tbody tr').not(check_class).hide();

  enroll_tables_with_no_data();
}

$(function(){

  // combobox

  $('[id^="enrollment_info"]').call_fancybox();

  $("#type, #curriculum_unit").combobox({
    change: enroll_combo_change
  });

  // combobox end

  // ------------------- \\

  // requests

  function enroll_error_request(data) {
    var data = $.parseJSON(data.responseText);
    if (typeof(data.alert) != "undefined")
      flash_message(data.alert, 'alert');
    if (typeof(data.msg) != "undefined")
      flash_message(data.msg, 'alert');
  }

  // ja matriculado e quer cancelar
  $('.allocation_cancel_enroll').click(function(e){
    e.preventDefault();

    if (!confirm("<%= I18n.t('enrollments.index.confirm') %>"))
      return false;

    var reactivate_url = $(this).attr('href').replace('cancel', 'reactivate')
    var td = $(this).closest('td');

    $.delete($(this).attr('href'), function(data){

      var enroll_link = '<a href="' + reactivate_url + '" class="btn btn_default request_enroll"><%= I18n.t('enrollments.index.enroll') %></a>';
      td.html(enroll_link);

      flash_message(data.notice, 'notice');
    }).error(enroll_error_request);
  });

  // pediu matricula e quer cancelar
  $('.allocation_cancel_request').click(function(e){
    e.preventDefault();

    if (!confirm("<%= I18n.t('enrollments.index.confirm') %>"))
      return false;

    var tr = $(this).closest('tr');
    var td = $(this).closest('td');

    $.delete($(this).attr('href'), function(data){
      var group_id = td.data('group-id');
      if (group_id) {
        var enroll_url = $('.allocations.list').data('link-enroll').replace('allocation_group_id', group_id);
        var enroll_link = '<a href="' + enroll_url + '" class="btn btn_default request_enroll"><%= I18n.t('enrollments.index.enroll') %></a>';

        td.html(enroll_link);
      } else {
        td.html('pt-br: pedido de matricula cancelado');
      }

      flash_message(data.notice, 'notice');
    }).error(enroll_error_request);
  });

  // pedir matricula
  $('table tbody tr.lines').on('click', 'a.request_enroll', function(e){
    e.preventDefault();

    var td = $(this).closest('td');
    $.post($(this).attr('href'), {format: 'json'}, function(data){
      var cancel_url = $('.allocations.list').data('link-cancel-request').replace(':allocation_id', data.id);
      var cancel_link = '<a href="' + cancel_url + '" class="btn btn_caution" data-method="delete" data-confirm="<%= I18n.t('enrollments.index.confirm') %>"><%= I18n.t('enrollments.index.cancel_request') %></a>';

      td.html(cancel_link);
      flash_message(data.notice, 'notice');

    }).error(enroll_error_request);
  });

}); // end function jquery

// -- EDX -- \\
$(function(){
  var search_data = {
    type: $("#type").val(),
    uc: $("#curriculum_unit").val()
  };

  $.get("<%= Rails.application.routes.url_helpers.available_edx_courses_path %>", search_data, function(data) {
    if($(data).length > 0)
      $(".any_found.text_none").remove();
    $(".tb_list.enrollment_list tbody").append(data);
  });
});
