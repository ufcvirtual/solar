/**
 * @license Copyright (c) 2003-2014, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
/**
 * @fileOverview [Widget](http://ckeditor.com/addon/widget) plugin.
 */
"use strict";(function(){function t(e){this.editor=e,this.registered={},this.instances={},this.selected=[],this.focused=null,this.widgetHoldingFocusedEditable=null,this._={nextId:0,upcasts:[],upcastCallbacks:[],filters:{}},j(this),B(this),D(this),P(this),_(this),H(this)}function n(e,t,r,i,s){var o=e.editor;CKEDITOR.tools.extend(this,i,{editor:o,id:t,inline:r.getParent().getName()=="span",element:r,data:CKEDITOR.tools.extend({},typeof i.defaults=="function"?i.defaults():i.defaults),dataReady:!1,inited:!1,ready:!1,edit:n.prototype.edit,focusedEditable:null,definition:i,repository:e,draggable:i.draggable!==!1,_:{downcastFn:i.downcast&&typeof i.downcast=="string"?i.downcasts[i.downcast]:i.downcast}},!0),e.fire("instanceCreated",this),Z(this,i),this.init&&this.init(),this.inited=!0,et(this,s),this.isInited()&&o.editable().contains(this.wrapper)&&(this.ready=!0,this.fire("ready"))}function r(e,t,n){CKEDITOR.dom.element.call(this,t.$),this.editor=e;var r=this.filter=n.filter;CKEDITOR.dtd[this.getName()].p?(this.enterMode=r?r.getAllowedEnterMode(e.enterMode):e.enterMode,this.shiftEnterMode=r?r.getAllowedEnterMode(e.shiftEnterMode,!0):e.shiftEnterMode):this.enterMode=this.shiftEnterMode=CKEDITOR.ENTER_BR}function i(e){var t=e.widgets.registered,n,r,i;for(r in t)n=t[r],i=n.button,i&&e.ui.addButton&&e.ui.addButton(CKEDITOR.tools.capitalize(n.name,!0),{label:i,command:n.name,toolbar:"insert,10"})}function s(e,t){e.addCommand(t.name,{exec:function(){function f(){e.widgets.finalizeCreation(u)}var n=e.widgets.focused;if(n&&n.name==t.name)n.edit();else if(t.insert)t.insert();else if(t.template){var r=typeof t.defaults=="function"?t.defaults():t.defaults,i=CKEDITOR.dom.element.createFromHtml(t.template.output(r)),s,o=e.widgets.wrapElement(i,t.name),u=new CKEDITOR.dom.documentFragment(o.getDocument());u.append(o),s=e.widgets.initOn(i,t);if(!s){f();return}var a=s.once("edit",function(t){t.data.dialog?s.once("dialog",function(t){var n=t.data,r,i;r=n.once("ok",f,null,null,20),i=n.once("cancel",function(){e.widgets.destroy(s,!0)}),n.once("hide",function(){r.removeListener(),i.removeListener()})}):f()},null,null,999);s.edit(),a.removeListener()}},refresh:function(e,t){this.setState(d(e.editable(),t.blockLimit)?CKEDITOR.TRISTATE_DISABLED:CKEDITOR.TRISTATE_OFF)},context:"div",allowedContent:t.allowedContent,requiredContent:t.requiredContent,contentForms:t.contentForms,contentTransformations:t.contentTransformations})}function o(e,t){var n=t.upcast,r;if(!n)return;if(typeof n=="string"){r=n.split(",");while(r.length)e._.upcasts.push([t.upcasts[r.pop()],t.name])}else e._.upcasts.push([n,t.name])}function u(e,t){e.focused=null,t.isInited()&&(e.fire("widgetBlurred",{widget:t}),t.setFocused(!1))}function a(e){var t=e.data;if(this.editor.mode!="wysiwyg")return;var n=this.editor.editable(),r=this.instances,i,s,o,u;if(!n)return;for(s in r)n.contains(r[s].wrapper)||this.destroy(r[s],!0);if(t&&t.initOnlyNew)i=this.initOnAll();else{var a=n.find(".cke_widget_wrapper");i=[];for(s=0,o=a.count();s<o;s++)u=a.getItem(s),!this.getByElement(u,!0)&&!p(u,x)&&(u.addClass("cke_widget_new"),i.push(this.initOn(u.getFirst(y))))}t&&t.focusInited&&i.length==1&&i[0].focus()}function f(e){var t=e.parent;t.type==CKEDITOR.NODE_ELEMENT&&t.attributes["data-cke-widget-wrapper"]&&t.replaceWith(e)}function l(e,t){var n=t.find(".cke_widget_wrapper"),r,i,s=0,o=n.count();for(;s<o;++s)r=n.getItem(s),i=r.getFirst(y),i.type==CKEDITOR.NODE_ELEMENT&&i.data("widget")?(i.replace(r),e.wrapElement(i)):r.remove()}function c(e,t,n){if(!n.allowedContent)return null;var r=this._.filters[e];r||(this._.filters[e]=r={});var i=r[t];return i||(r[t]=i=new CKEDITOR.filter(n.allowedContent)),i}function h(e){var t=[],n=e._.upcasts,r=e._.upcastCallbacks;return{toBeWrapped:t,iterator:function(e){var i,s,o,u,a,f;if("data-cke-widget-wrapper"in e.attributes)return e=e.getFirst(g),e&&t.push([e]),!1;if("data-widget"in e.attributes)return t.push([e]),!1;if(a=n.length){if(e.attributes["data-cke-widget-upcasted"])return!1;for(u=0,f=r.length;u<f;++u)if(r[u](e)===!1)return;for(u=0;u<a;++u){i=n[u],o={};if(s=i[0](e,o))return s instanceof CKEDITOR.htmlParser.element&&(e=s),e.attributes["data-cke-widget-data"]=JSON.stringify(o),e.attributes["data-cke-widget-upcasted"]=1,t.push([e,i[1]]),!1}}}}}function p(e,t){var n=e;while(n=n.getParent())if(t(n))return!0;return!1}function d(e,t){return!t||t.equals(e)?null:S(t)?t:d(e,t.getParent())}function v(e){return{tabindex:-1,contenteditable:"false","data-cke-widget-wrapper":1,"data-cke-filter":"off","class":"cke_widget_wrapper cke_widget_new cke_widget_"+(e?"inline":"block")}}function m(e,t,n){if(e.type==CKEDITOR.NODE_ELEMENT){var r=CKEDITOR.dtd[e.name];if(r&&!r[n.name]){var i=e.split(t),s=e.parent;return t=i.getIndex(),e.children.length||(t-=1,e.remove()),i.children.length||i.remove(),m(s,t,n)}}e.add(n,t)}function g(e){return e.type==CKEDITOR.NODE_ELEMENT&&!!e.attributes["data-widget"]}function y(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-widget")}function b(e,t){return typeof e.inline=="boolean"?e.inline:!!CKEDITOR.dtd.$inline[t]}function w(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.attributes["data-cke-widget-wrapper"]}function E(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-wrapper")}function S(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-editable")}function x(e){return e.hasAttribute("data-cke-temp")}function T(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-drag-handler")}function N(e,t,n){t.focus(),e.fire("saveSnapshot"),e.fire("lockSnapshot",{dontUpdate:!0}),n.select();var r=t.wrapper.getOuterHtml();t.wrapper.remove(),e.widgets.destroy(t,!0),e.execCommand("paste",r),e.fire("unlockSnapshot")}function C(e,t){var n=t.data.$,r,i=e.createRange();if(t.data.testRange)return t.data.testRange;if(document.caretRangeFromPoint)r=e.document.$.caretRangeFromPoint(n.clientX,n.clientY),i.setStart(CKEDITOR.dom.node(r.startContainer),r.startOffset),i.collapse(!0);else if(n.rangeParent)i.setStart(CKEDITOR.dom.node(n.rangeParent),n.rangeOffset),i.collapse(!0);else{if(!document.body.createTextRange)return null;r=e.document.getBody().$.createTextRange(),r.moveToPoint(n.clientX,n.clientY);var s="cke-temp-"+(new Date).getTime();r.pasteHTML('<span id="'+s+'">​</span>');var o=e.document.getById(s);i.moveToPosition(o,CKEDITOR.POSITION_BEFORE_START),o.remove()}return i}function k(e,t){var n=e.focusedEditable,r;if(t==CKEDITOR.CTRL+65){var i=n.getBogus();return r=e.editor.createRange(),r.selectNodeContents(n),i&&r.setEndAt(i,CKEDITOR.POSITION_BEFORE_START),r.select(),!1}if(t==8||t==46){var s=e.editor.getSelection().getRanges();return r=s[0],s.length!=1||!r.collapsed||!r.checkBoundaryOfElement(n,CKEDITOR[t==8?"START":"END"])}}function L(e,t,n,r){var i=e.editor;i.fire("lockSnapshot");if(n){var s=n.data("cke-widget-editable"),o=t.editables[s];e.widgetHoldingFocusedEditable=t,t.focusedEditable=o,n.addClass("cke_widget_editable_focused"),o.filter&&i.setActiveFilter(o.filter),i.setActiveEnterMode(o.enterMode,o.shiftEnterMode)}else r||t.focusedEditable.removeClass("cke_widget_editable_focused"),t.focusedEditable=null,e.widgetHoldingFocusedEditable=null,i.setActiveFilter(null),i.setActiveEnterMode(null,null);i.fire("unlockSnapshot")}function A(e){if(!e.contextMenu)return;e.contextMenu.addListener(function(t){var n=e.widgets.getByElement(t,!0);if(n)return n.fire("contextMenu",{})})}function M(e,t){return CKEDITOR.tools.trim(t)}function _(e){var t=e.editor,n=CKEDITOR.plugins.lineutils;t.on("contentDom",function(){var r=t.editable(),i=CKEDITOR.env.ie&&CKEDITOR.env.version<9||r.isInline()?r:t.document;r.attachListener(i,"drop",function(n){var r=n.data.$.dataTransfer.getData("text"),i,s,o;if(!r)return;try{i=JSON.parse(r)}catch(u){return}if(i.type!="cke-widget")return;n.data.preventDefault();if(i.editor!=t.name||!(s=e.instances[i.id]))return;o=C(t,n);if(!o)return;CKEDITOR.env.gecko?setTimeout(N,0,t,s,o):N(t,s,o)}),CKEDITOR.tools.extend(e,{finder:new n.finder(t,{lookups:{"default":function(e){if(e.is(CKEDITOR.dtd.$listItem))return;if(!e.is(CKEDITOR.dtd.$block))return;while(e){if(S(e))return;e=e.getParent()}return CKEDITOR.LINEUTILS_BEFORE|CKEDITOR.LINEUTILS_AFTER}}}),locator:new n.locator(t),liner:new n.liner(t,{lineStyle:{cursor:"move !important","border-top-color":"#666"},tipLeftStyle:{"border-left-color":"#666"},tipRightStyle:{"border-right-color":"#666"}})},!0)})}function D(e){var t=e.editor;t.on("contentDom",function(){var n=t.editable(),r=n.isInline()?n:t.document,i,s;n.attachListener(r,"mousedown",function(t){var n=t.data.getTarget();if(!n.type)return!1;i=e.getByElement(n),s=0;if(i){if(i.inline&&n.type==CKEDITOR.NODE_ELEMENT&&n.hasAttribute("data-cke-widget-drag-handler")){s=1;return}d(i.wrapper,n)?i=null:(t.data.preventDefault(),CKEDITOR.env.ie||i.focus())}}),n.attachListener(r,"mouseup",function(){i&&s&&(s=0,i.focus())}),CKEDITOR.env.ie&&n.attachListener(r,"mouseup",function(e){i&&setTimeout(function(){i.focus(),i=null})})}),t.on("doubleclick",function(t){var n=e.getByElement(t.data.element);if(!n||d(n.wrapper,t.data.element))return;return n.fire("doubleclick",{element:t.data.element})},null,null,1)}function P(e){var t=e.editor;t.on("key",function(t){var n=e.focused,r=e.widgetHoldingFocusedEditable,i;return n?i=n.fire("key",{keyCode:t.data.keyCode}):r&&(i=k(r,t.data.keyCode)),i},null,null,1)}function H(e){function n(t){e.focused&&W(e.focused,t.name=="cut")}var t=e.editor;t.on("contentDom",function(){var e=t.editable();e.attachListener(e,"copy",n),e.attachListener(e,"cut",n)})}function B(e){var t=e.editor;t.on("selectionCheck",function(){e.fire("checkSelection")}),e.on("checkSelection",e.checkSelection,e),t.on("selectionChange",function(n){var r=d(t.editable(),n.data.selection.getStartElement()),i=r&&e.getByElement(r),s=e.widgetHoldingFocusedEditable;if(s){if(s!==i||!s.focusedEditable.equals(r))L(e,s,null),i&&r&&L(e,i,r)}else i&&r&&L(e,i,r)}),t.on("dataReady",function(t){q(e).commit()}),t.on("blur",function(){var t;(t=e.focused)&&u(e,t),(t=e.widgetHoldingFocusedEditable)&&L(e,t,null)})}function j(e){I(e),F(e),e.on("checkWidgets",a),e.editor.on("contentDomInvalidated",e.checkWidgets,e)}function F(e){var t=e.editor,n={},r=!1;t.on("toDataFormat",function(t){var r=CKEDITOR.tools.getNextNumber(),i=[];t.data.downcastingSessionId=r,n[r]=i,t.data.dataValue.forEach(function(t){var n=t.attributes,r,s;if("data-cke-widget-id"in n)r=e.instances[n["data-cke-widget-id"]],r&&(s=t.getFirst(g),i.push({wrapper:t,element:s,widget:r,editables:{}}),s.attributes["data-cke-widget-keep-attr"]!="1"&&delete s.attributes["data-widget"]);else if("data-cke-widget-editable"in n)return i[i.length-1].editables[n["data-cke-widget-editable"]]=t,!1},CKEDITOR.NODE_ELEMENT,!0)},null,null,8),t.on("toDataFormat",function(e){if(!e.data.downcastingSessionId)return;var t=n[e.data.downcastingSessionId],r,i,s,o,u,a;while(r=t.shift()){i=r.widget,s=r.element,o=i._.downcastFn&&i._.downcastFn.call(i,s);for(a in r.editables)u=r.editables[a],delete u.attributes.contenteditable,u.setHtml(i.editables[a].getData());o||(o=s),r.wrapper.replaceWith(o)}},null,null,13),t.on("contentDomUnload",function(){e.destroyAll(!0)})}function I(e){function i(){t.fire("lockSnapshot"),e.checkWidgets({initOnlyNew:!0,focusInited:n}),t.fire("unlockSnapshot")}var t=e.editor,n,r;t.on("toHtml",function(t){var r=h(e),i;t.data.dataValue.forEach(r.iterator,CKEDITOR.NODE_ELEMENT,!0);while(i=r.toBeWrapped.pop())f(i[0]),e.wrapElement(i[0],i[1]);n=t.data.dataValue.children.length==1&&w(t.data.dataValue.children[0])},null,null,8),t.on("dataReady",function(){r&&l(e,t.editable()),r=0,e.destroyAll(!0),e.initOnAll()}),t.on("loadSnapshot",function(t){/data-cke-widget/.test(t.data)&&(r=1),e.destroyAll(!0)},null,null,9),t.on("paste",function(e){e.data.dataValue=e.data.dataValue.replace(O,M)}),t.on("insertText",i,null,null,999),t.on("insertHtml",i,null,null,999)}function q(e){var t=e.selected,n=[],r=t.slice(0),i=null;return{select:function(e){CKEDITOR.tools.indexOf(t,e)<0&&n.push(e);var i=CKEDITOR.tools.indexOf(r,e);return i>=0&&r.splice(i,1),this},focus:function(e){return i=e,this},commit:function(){var s=e.focused!==i,o;e.editor.fire("lockSnapshot"),s&&(o=e.focused)&&u(e,o);while(o=r.pop())t.splice(CKEDITOR.tools.indexOf(t,o),1),o.isInited()&&o.setSelected(!1);s&&i&&(e.focused=i,e.fire("widgetFocused",{widget:i}),i.setFocused(!0));while(o=n.pop())t.push(o),o.setSelected(!0);e.editor.fire("unlockSnapshot")}}}function z(e){e.cancel()}function W(e,t){var n=e.editor,r=n.document;if(r.getById("cke_copybin"))return;var i=n.blockless||CKEDITOR.env.ie?"span":"div",s=r.createElement(i),o=r.createElement(i),u=CKEDITOR.env.ie&&CKEDITOR.env.version<9;o.setAttributes({id:"cke_copybin","data-cke-temp":"1"}),s.setStyles({position:"absolute",width:"1px",height:"1px",overflow:"hidden"}),s.setStyle(n.config.contentsLangDirection=="ltr"?"left":"right","-5000px"),s.setHtml('<span data-cke-copybin-start="1">​</span>'+e.wrapper.getOuterHtml()+'<span data-cke-copybin-end="1">​</span>'),n.fire("saveSnapshot"),n.fire("lockSnapshot"),o.append(s),n.editable().append(o);var a=n.on("selectionChange",z,null,null,0),f=e.repository.on("checkSelection",z,null,null,0);if(u)var l=r.getDocumentElement().$,c=l.scrollTop;var h=n.createRange();h.selectNodeContents(s),h.select(),u&&(l.scrollTop=c),setTimeout(function(){t||e.focus(),o.remove(),a.removeListener(),f.removeListener(),n.fire("unlockSnapshot"),t&&(e.repository.del(e),n.fire("saveSnapshot"))},100)}function X(){var e=CKEDITOR.document.getActive(),t=this.editor,n=t.editable();(n.isInline()?n:t.document.getWindow().getFrame()).equals(e)&&t.focusManager.focus(n)}function V(){CKEDITOR.env.gecko&&this.editor.unlockSelection(),CKEDITOR.env.webkit||(this.editor.forceNextSelectionCheck(),this.editor.selectionChange(1))}function $(t){if(!t.draggable)return;var n=t.editor,r=t.wrapper.findOne(".cke_widget_drag_handler_container"),i;r?i=r.findOne("img"):(r=new CKEDITOR.dom.element("span",n.document),r.setAttributes({"class":"cke_reset cke_widget_drag_handler_container",style:"background:rgba(220,220,220,0.5);background-image:url("+n.plugins.widget.path+"images/handle.png)"}),i=new CKEDITOR.dom.element("img",n.document),i.setAttributes({"class":"cke_reset cke_widget_drag_handler","data-cke-widget-drag-handler":"1",src:R,width:e,title:n.lang.widget.move,height:e}),t.inline&&i.setAttribute("draggable","true"),r.append(i),t.wrapper.append(r)),t.wrapper.on("mouseenter",t.updateDragHandlerPosition,t),setTimeout(function(){t.on("data",t.updateDragHandlerPosition,t)},50),t.inline?i.on("dragstart",function(e){e.data.$.dataTransfer.setData("text",JSON.stringify({type:"cke-widget",editor:n.name,id:t.id}))}):i.on("mousedown",J,t),t.dragHandlerContainer=r}function J(){function c(){var e;a.reset();while(e=s.pop())e.removeListener();K.call(this,o)}var e=this.repository.finder,t=this.repository.locator,n=this.repository.liner,r=this.editor,i=r.editable(),s=[],o=[],u=e.greedySearch(),a=CKEDITOR.tools.eventsBuffer(50,function(){f=t.locate(u),o=t.sort(l,1),o.length&&(n.prepare(u,f),n.placeLine(o[0]),n.cleanup())}),f,l;i.addClass("cke_widget_dragging"),s.push(i.on("mousemove",function(e){l=e.data.$.clientY,a.input()})),s.push(r.document.once("mouseup",c,this)),s.push(CKEDITOR.document.once("mouseup",c,this))}function K(e){var t=this.repository.finder,n=this.repository.liner,r=this.editor,i=this.editor.editable();if(!CKEDITOR.tools.isEmpty(n.visible)){var s=t.getRange(e[0]);this.focus(),r.fire("saveSnapshot"),r.fire("lockSnapshot",{dontUpdate:1}),r.getSelection().reset(),i.insertElementIntoRange(this.wrapper,s),this.focus(),r.fire("unlockSnapshot"),r.fire("saveSnapshot")}i.removeClass("cke_widget_dragging"),n.hideVisible()}function Q(e){var t,n,r=e.editables;e.editables={};if(!e.editables)return;for(t in r)n=r[t],e.initEditable(t,typeof n=="string"?{selector:n}:n)}function G(e){if(!e.mask)return;var t=e.wrapper.findOne(".cke_widget_mask");t||(t=new CKEDITOR.dom.element("img",e.editor.document),t.setAttributes({src:R,"class":"cke_reset cke_widget_mask"}),e.wrapper.append(t)),e.mask=t}function Y(e){if(e.parts){var t={},n,r;for(r in e.parts)n=e.wrapper.findOne(e.parts[r]),t[r]=n;e.parts=t}}function Z(e,t){tt(e),Y(e),Q(e),G(e),$(e),CKEDITOR.env.ie&&CKEDITOR.env.version<9&&e.wrapper.on("dragstart",function(t){var n=t.data.getTarget();!d(e,n)&&(!e.inline||!T(n))&&t.data.preventDefault()}),e.wrapper.removeClass("cke_widget_new"),e.element.addClass("cke_widget_element"),e.on("key",function(t){var n=t.data.keyCode;if(n==13)e.edit();else{if(n==CKEDITOR.CTRL+67||n==CKEDITOR.CTRL+88){W(e,n==CKEDITOR.CTRL+88);return}if(n in U||CKEDITOR.CTRL&n||CKEDITOR.ALT&n)return}return!1},null,null,999),e.on("doubleclick",function(t){e.edit()}),t.data&&e.on("data",t.data),t.edit&&e.on("edit",t.edit)}function et(e,t){var n=e.element.data("cke-widget-data");n&&e.setData(JSON.parse(n)),t&&e.setData(t),e.dataReady=!0,nt(e),e.fire("data",e.data)}function tt(e){var t=e.wrapper=e.element.getParent();t.setAttribute("data-cke-widget-id",e.id)}function nt(e){e.element.data("cke-widget-data",JSON.stringify(e.data))}var e=15;CKEDITOR.plugins.add("widget",{lang:"ar,ca,cs,cy,de,el,en,en-gb,es,fa,fi,fr,gl,hr,hu,ja,km,ko,nb,nl,no,pl,pt,pt-br,ru,sl,sv,uk,zh,zh-cn",requires:"lineutils,clipboard",onLoad:function(){CKEDITOR.addCss(".cke_widget_wrapper{position:relative;outline:none}.cke_widget_inline{display:inline-block}.cke_widget_wrapper:hover>.cke_widget_element{outline:2px solid yellow;cursor:default}.cke_widget_wrapper:hover .cke_widget_editable{outline:2px solid yellow}.cke_widget_wrapper.cke_widget_focused>.cke_widget_element,.cke_widget_wrapper .cke_widget_editable.cke_widget_editable_focused{outline:2px solid #ace}.cke_widget_editable{cursor:text}.cke_widget_drag_handler_container{position:absolute;width:"+e+"px;"+"height:0;"+"left:-9999px;"+"opacity:0.75;"+"transition:height 0s 0.2s;"+"line-height:0"+"}"+".cke_widget_wrapper:hover>.cke_widget_drag_handler_container{"+"height:"+e+"px;"+"transition:none"+"}"+".cke_widget_drag_handler_container:hover{"+"opacity:1"+"}"+"img.cke_widget_drag_handler{"+"cursor:move;"+"width:"+e+"px;"+"height:"+e+"px;"+"display:inline-block"+"}"+".cke_widget_mask{"+"position:absolute;"+"top:0;"+"left:0;"+"width:100%;"+"height:100%;"+"display:block"+"}"+".cke_editable.cke_widget_dragging, .cke_editable.cke_widget_dragging *{"+"cursor:move !important"+"}")},beforeInit:function(e){e.widgets=new t(e)},afterInit:function(e){i(e),A(e)}}),t.prototype={MIN_SELECTION_CHECK_INTERVAL:500,add:function(e,t){return t=CKEDITOR.tools.prototypedCopy(t),t.name=e,t._=t._||{},this.editor.fire("widgetDefinition",t),t.template&&(t.template=new CKEDITOR.template(t.template)),s(this.editor,t),o(this,t),t.button||this.editor.addFeature(t),this.registered[e]=t,t},addUpcastCallback:function(e){this._.upcastCallbacks.push(e)},checkSelection:function(){var e=this.editor.getSelection(),t=e.getSelectedElement(),n=q(this),r;if(t&&(r=this.getByElement(t,!0)))return n.focus(r).select(r).commit();var i=e.getRanges()[0];if(!i||i.collapsed)return n.commit();var s=new CKEDITOR.dom.walker(i),o;s.evaluator=E;while(o=s.next())n.select(this.getByElement(o));n.commit()},checkWidgets:function(e){this.fire("checkWidgets",CKEDITOR.tools.copy(e||{}))},del:function(e){if(this.focused===e){var t=e.editor,n=t.createRange(),r;(r=n.moveToClosestEditablePosition(e.wrapper,!0))||(r=n.moveToClosestEditablePosition(e.wrapper,!1)),r&&t.getSelection().selectRanges([n])}e.wrapper.remove(),this.destroy(e,!0)},destroy:function(e,t){this.widgetHoldingFocusedEditable===e&&L(this,e,null,t),e.destroy(t),delete this.instances[e.id],this.fire("instanceDestroyed",e)},destroyAll:function(e){var t=this.instances,n;for(var r in t)n=t[r],this.destroy(n,e)},finalizeCreation:function(e){var t=e.getFirst();if(t&&E(t)){this.editor.insertElement(t);var n=this.getByElement(t);n.ready=!0,n.fire("ready"),n.focus()}},getByElement:function(e,t){if(!e)return null;var n;for(var r in this.instances){n=this.instances[r].wrapper;if(n.equals(e)||!t&&n.contains(e))return this.instances[r]}return null},initOn:function(e,t,r){t?typeof t=="string"&&(t=this.registered[t]):t=this.registered[e.data("widget")];if(!t)return null;var i=this.wrapElement(e,t.name);if(i){if(i.hasClass("cke_widget_new")){var s=new n(this,this._.nextId++,e,t,r);return s.isInited()?(this.instances[s.id]=s,s):null}return this.getByElement(e)}return null},initOnAll:function(e){var t=(e||this.editor.editable()).find(".cke_widget_new"),n=[],r;for(var i=t.count();i--;)r=this.initOn(t.getItem(i).getFirst(y)),r&&n.push(r);return n},wrapElement:function(e,t){var n=null,r,i;if(e instanceof CKEDITOR.dom.element){r=this.registered[t||e.data("widget")];if(!r)return null;n=e.getParent();if(n&&n.type==CKEDITOR.NODE_ELEMENT&&n.data("cke-widget-wrapper"))return n;e.hasAttribute("data-cke-widget-keep-attr")||e.data("cke-widget-keep-attr",e.data("widget")?1:0),t&&e.data("widget",t),i=b(r,e.getName()),n=new CKEDITOR.dom.element(i?"span":"div"),n.setAttributes(v(i)),n.data("cke-display-name",r.pathName?r.pathName:e.getName()),e.getParent(!0)&&n.replace(e),e.appendTo(n)}else if(e instanceof CKEDITOR.htmlParser.element){r=this.registered[t||e.attributes["data-widget"]];if(!r)return null;n=e.parent;if(n&&n.type==CKEDITOR.NODE_ELEMENT&&n.attributes["data-cke-widget-wrapper"])return n;"data-cke-widget-keep-attr"in e.attributes||(e.attributes["data-cke-widget-keep-attr"]=e.attributes["data-widget"]?1:0),t&&(e.attributes["data-widget"]=t),i=b(r,e.name),n=new CKEDITOR.htmlParser.element(i?"span":"div",v(i)),n.attributes["data-cke-display-name"]=r.pathName?r.pathName:e.name;var s=e.parent,o;s&&(o=e.getIndex(),e.remove()),n.add(e),s&&m(s,o,n)}return n},_tests_getNestedEditable:d,_tests_createEditableFilter:c},CKEDITOR.event.implementOn(t.prototype),n.prototype={destroy:function(e){var t=this.editor;this.fire("destroy");if(this.editables)for(var n in this.editables)this.destroyEditable(n,e);e||(this.element.data("cke-widget-keep-attr")=="0"&&this.element.removeAttribute("data-widget"),this.element.removeAttributes(["data-cke-widget-data","data-cke-widget-keep-attr"]),this.element.removeClass("cke_widget_element"),this.element.replace(this.wrapper)),this.wrapper=null},destroyEditable:function(e,t){var n=this.editables[e];n.removeListener("focus",V),n.removeListener("blur",X),this.editor.focusManager.remove(n),t||(n.removeClass("cke_widget_editable"),n.removeClass("cke_widget_editable_focused"),n.removeAttributes(["contenteditable","data-cke-widget-editable","data-cke-enter-mode"])),delete this.editables[e]},edit:function(){var e={dialog:this.dialog},t=this;if(this.fire("edit",e)===!1||!e.dialog)return;this.editor.openDialog(e.dialog,function(e){var n,r;if(t.fire("dialog",e)===!1)return;n=e.on("show",function(){e.setupContent(t)}),r=e.on("ok",function(){var n,r=t.on("data",function(e){n=1,e.cancel()},null,null,0);t.editor.fire("saveSnapshot"),e.commitContent(t),r.removeListener(),n&&(t.fire("data",t.data),t.editor.fire("saveSnapshot"))}),e.once("hide",function(){n.removeListener(),r.removeListener()})})},initEditable:function(e,t){var n=this.wrapper.findOne(t.selector);return n&&n.is(CKEDITOR.dtd.$editable)?(n=new r(this.editor,n,{filter:c.call(this.repository,this.name,e,t)}),this.editables[e]=n,n.setAttributes({contenteditable:"true","data-cke-widget-editable":e,"data-cke-enter-mode":n.enterMode}),n.filter&&n.data("cke-filter",n.filter.id),n.addClass("cke_widget_editable"),n.removeClass("cke_widget_editable_focused"),t.pathName&&n.data("cke-display-name",t.pathName),this.editor.focusManager.add(n),n.on("focus",V,this),CKEDITOR.env.ie&&n.on("blur",X,this),n.setData(n.getHtml()),!0):!1},isInited:function(){return!!this.wrapper&&!!this.inited},isReady:function(){return this.isInited()&&this.ready},focus:function(){var e=this.editor.getSelection();e&&e.fake(this.wrapper),this.editor.focus()},setData:function(e,t){var n=this.data,r=0;if(typeof e=="string")n[e]!==t&&(n[e]=t,r=1);else{var i=e;for(e in i)n[e]!==i[e]&&(r=1,n[e]=i[e])}return r&&this.dataReady&&(nt(this),this.fire("data",n)),this},setFocused:function(e){return this.wrapper[e?"addClass":"removeClass"]("cke_widget_focused"),this.fire(e?"focus":"blur"),this},setSelected:function(e){return this.wrapper[e?"addClass":"removeClass"]("cke_widget_selected"),this.fire(e?"select":"deselect"),this},updateDragHandlerPosition:function(){var t=this.editor,n=this.element.$,r=this._.dragHandlerOffset,i={x:n.offsetLeft,y:n.offsetTop-e};if(r&&i.x==r.x&&i.y==r.y)return;var s=t.checkDirty();t.fire("lockSnapshot"),this.dragHandlerContainer.setStyles({top:i.y+"px",left:i.x+"px"}),t.fire("unlockSnapshot"),!s&&t.resetDirty(),this._.dragHandlerOffset=i}},CKEDITOR.event.implementOn(n.prototype),r.prototype=CKEDITOR.tools.extend(CKEDITOR.tools.prototypedCopy(CKEDITOR.dom.element.prototype),{setData:function(e){e=this.editor.dataProcessor.toHtml(e,{context:this.getName(),filter:this.filter,enterMode:this.enterMode}),this.setHtml(e)},getData:function(){return this.editor.dataProcessor.toDataFormat(this.getHtml(),{context:this.getName(),filter:this.filter,enterMode:this.enterMode})}});var O=new RegExp('^(?:<(?:div|span)(?: data-cke-temp="1")?(?: id="cke_copybin")?(?: data-cke-temp="1")?>)?(?:<(?:div|span)(?: style="[^"]+")?>)?<span [^>]*data-cke-copybin-start="1"[^>]*>.?</span>([\\s\\S]+)<span [^>]*data-cke-copybin-end="1"[^>]*>.?</span>(?:</(?:div|span)>)?(?:</(?:div|span)>)?$'),R="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw%3D%3D",U={37:1,38:1,39:1,40:1,8:1,46:1};CKEDITOR.plugins.widget=n,n.repository=t,n.nestedEditable=r})();