/**
 * @license Copyright (c) 2003-2014, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
/**
 * @fileOverview A set of utilities to find and make horizontal spaces in edited contents.
 */
"use strict";(function(){function e(e,t){CKEDITOR.tools.extend(this,{editor:e,editable:e.editable(),doc:e.document,win:e.window},t,!0),this.frame=this.win.getFrame(),this.inline=this.editable.isInline(),this.target=this[this.inline?"editable":"doc"]}function t(e,t){CKEDITOR.tools.extend(this,t,{editor:e},!0)}function s(e,t){var s=e.editable();CKEDITOR.tools.extend(this,{editor:e,editable:s,doc:e.document,win:e.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},t,!0),this.hidden={},this.visible={},this.inline=s.isInline(),this.inline||(this.frame=this.win.getFrame()),this.queryViewport();var o=CKEDITOR.tools.bind(this.queryViewport,this),u=CKEDITOR.tools.bind(this.hideVisible,this),a=CKEDITOR.tools.bind(this.removeAll,this);s.attachListener(this.winTop,"resize",o),s.attachListener(this.winTop,"scroll",o),s.attachListener(this.winTop,"resize",u),s.attachListener(this.win,"scroll",u),s.attachListener(this.inline?s:this.frame,"mouseout",function(e){var t=e.data.$.clientX,n=e.data.$.clientY;this.queryViewport(),(t<=this.rect.left||t>=this.rect.right||n<=this.rect.top||n>=this.rect.bottom)&&this.hideVisible(),(t<=0||t>=this.winTopPane.width||n<=0||n>=this.winTopPane.height)&&this.hideVisible()},this),s.attachListener(e,"resize",o),s.attachListener(e,"mode",a),e.on("destroy",a),this.lineTpl=(new CKEDITOR.template(i)).output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},r,this.lineStyle,!0)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},n,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,!0)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},n,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,!0))})}function o(e,t){return e&t}function f(e){return e&&e.type==CKEDITOR.NODE_ELEMENT}function l(e){return!!u[e.getComputedStyle("float")]||!!u[e.getAttribute("align")]}function c(e){return!!a[e.getComputedStyle("position")]}function h(e){return f(e)&&e.getAttribute("contenteditable")=="true"}function p(e){return f(e)&&!l(e)&&!c(e)}CKEDITOR.plugins.add("lineutils"),CKEDITOR.LINEUTILS_BEFORE=1,CKEDITOR.LINEUTILS_AFTER=2,CKEDITOR.LINEUTILS_INSIDE=4,e.prototype={start:function(e){var t=this,n=this.editor,r=this.doc,i,s,o,u=CKEDITOR.tools.eventsBuffer(50,function(){if(n.readOnly||n.mode!="wysiwyg")return;t.relations={},i=new CKEDITOR.dom.element(r.$.elementFromPoint(s,o)),t.traverseSearch(i),isNaN(s+o)||t.pixelSearch(i,s,o),e&&e(t.relations,s,o)});this.listener=this.editable.attachListener(this.target,"mousemove",function(e){s=e.data.$.clientX,o=e.data.$.clientY,u.input()}),this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(e){u.reset()})},stop:function(){this.listener&&this.listener.removeListener()},getRange:function(){var e={};return e[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START,e[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END,e[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START,function(t){var n=this.editor.createRange();return n.moveToPosition(this.relations[t.uid].element,e[t.type]),n}}(),store:function(){function e(e,t,n){var r=e.getUniqueId();r in n?n[r].type|=t:n[r]={element:e,type:t}}return function(t,n){var r;o(n,CKEDITOR.LINEUTILS_AFTER)&&p(r=t.getNext())&&r.isVisible()&&(e(r,CKEDITOR.LINEUTILS_BEFORE,this.relations),n^=CKEDITOR.LINEUTILS_AFTER),o(n,CKEDITOR.LINEUTILS_INSIDE)&&p(r=t.getFirst())&&r.isVisible()&&(e(r,CKEDITOR.LINEUTILS_BEFORE,this.relations),n^=CKEDITOR.LINEUTILS_INSIDE),e(t,n,this.relations)}}(),traverseSearch:function(e){var t,n,r;do{r=e.$["data-cke-expando"];if(r&&r in this.relations)continue;if(e.equals(this.editable))return;if(p(e))for(t in this.lookups)(n=this.lookups[t](e))&&this.store(e,n)}while(!h(e)&&(e=e.getParent()))},pixelSearch:function(){function t(t,n,r,i,s){var o=r,u=0,a,f;while(s(o)){o+=i;if(++u==25)return;a=this.doc.$.elementFromPoint(n,o);if(!a)continue;if(a==t){u=0;continue}if(!e(t,a))continue;u=0;if(p(a=new CKEDITOR.dom.element(a)))return a}}var e=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(e,t){return e.contains(t)}:function(e,t){return!!(e.compareDocumentPosition(t)&16)};return function(e,n,r){var i=this.win.getViewPaneSize().height,s=t.call(this,e.$,n,r,-1,function(e){return e>0}),o=t.call(this,e.$,n,r,1,function(e){return e<i});if(s){this.traverseSearch(s);while(!s.getParent().equals(e))s=s.getParent()}if(o){this.traverseSearch(o);while(!o.getParent().equals(e))o=o.getParent()}while(s||o){s&&(s=s.getNext(p));if(!s||s.equals(o))break;this.traverseSearch(s),o&&(o=o.getPrevious(p));if(!o||o.equals(s))break;this.traverseSearch(o)}}}(),greedySearch:function(){this.relations={};var e=this.editable.getElementsByTag("*"),t=0,n,r,i;while(n=e.getItem(t++)){if(n.equals(this.editable))continue;if(!n.hasAttribute("contenteditable")&&n.isReadOnly())continue;if(p(n)&&n.isVisible())for(i in this.lookups)(r=this.lookups[i](n))&&this.store(n,r)}return this.relations}},t.prototype={locate:function(){function n(e,t){var n=e.element[t===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();return n&&p(n)?(e.siblingRect=n.getClientRect(),t==CKEDITOR.LINEUTILS_BEFORE?(e.siblingRect.bottom+e.elementRect.top)/2:(e.elementRect.bottom+e.siblingRect.top)/2):t==CKEDITOR.LINEUTILS_BEFORE?e.elementRect.top:e.elementRect.bottom}var e,t;return function(r){this.locations={};for(t in r)e=r[t],e.elementRect=e.element.getClientRect(),o(e.type,CKEDITOR.LINEUTILS_BEFORE)&&this.store(t,CKEDITOR.LINEUTILS_BEFORE,n(e,CKEDITOR.LINEUTILS_BEFORE)),o(e.type,CKEDITOR.LINEUTILS_AFTER)&&this.store(t,CKEDITOR.LINEUTILS_AFTER,n(e,CKEDITOR.LINEUTILS_AFTER)),o(e.type,CKEDITOR.LINEUTILS_INSIDE)&&this.store(t,CKEDITOR.LINEUTILS_INSIDE,(e.elementRect.top+e.elementRect.bottom)/2);return this.locations}}(),sort:function(){function o(t){return Math.abs(t-e[r][i])}var e,t,n,r,i,s;return function(u,a){e=this.locations,t=[];for(r in e)for(i in e[r]){n=o(u);if(!t.length)t.push({uid:+r,type:i,dist:n});else{for(s=0;s<t.length;s++)if(n<t[s].dist){t.splice(s,0,{uid:+r,type:i,dist:n});break}s==t.length&&t.push({uid:+r,type:i,dist:n})}}return typeof a!="undefined"?t.slice(0,a):t}}(),store:function(e,t,n){this.locations[e]||(this.locations[e]={}),this.locations[e][t]=n}};var n={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},r={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999},i='<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}"><span style="{tipLeftStyle}">&nbsp;</span><span style="{tipRightStyle}">&nbsp;</span></div>';s.prototype={removeAll:function(){var e;for(e in this.hidden)this.hidden[e].remove(),delete this.hidden[e];for(e in this.visible)this.visible[e].remove(),delete this.visible[e]},hideLine:function(e){var t=e.getUniqueId();e.hide(),this.hidden[t]=e,delete this.visible[t]},showLine:function(e){var t=e.getUniqueId();e.show(),this.visible[t]=e,delete this.hidden[t]},hideVisible:function(){for(var e in this.visible)this.hideLine(this.visible[e])},placeLine:function(e,t){var n,r,i;if(!(n=this.getStyle(e.uid,e.type)))return;for(i in this.visible)if(this.visible[i].getCustomData("hash")!==this.hash){r=this.visible[i];break}if(!r)for(i in this.hidden)if(this.hidden[i].getCustomData("hash")!==this.hash){this.showLine(r=this.hidden[i]);break}r||this.showLine(r=this.addLine()),r.setCustomData("hash",this.hash),this.visible[r.getUniqueId()]=r,r.setStyles(n),t&&t(r)},getStyle:function(e,t){var n=this.relations[e],r=this.locations[e][t],i={},s;n.siblingRect?i.width=Math.max(n.siblingRect.width,n.elementRect.width):i.width=n.elementRect.width,this.inline?i.top=r+this.winTopScroll.y:i.top=this.rect.top+this.winTopScroll.y+r;if(i.top-this.winTopScroll.y<this.rect.top||i.top-this.winTopScroll.y>this.rect.bottom)return!1;this.inline?i.left=n.elementRect.left:(n.elementRect.left>0?i.left=this.rect.left+n.elementRect.left:(i.width+=n.elementRect.left,i.left=this.rect.left),(s=i.left+i.width-(this.rect.left+this.winPane.width))>0&&(i.width-=s)),i.left+=this.winTopScroll.x;for(var o in i)i[o]=CKEDITOR.tools.cssLength(i[o]);return i},addLine:function(){var e=CKEDITOR.dom.element.createFromHtml(this.lineTpl);return e.appendTo(this.container),e},prepare:function(e,t){this.relations=e,this.locations=t,this.hash=Math.random()},cleanup:function(){var e;for(var t in this.visible)e=this.visible[t],e.getCustomData("hash")!==this.hash&&this.hideLine(e)},queryViewport:function(){this.winPane=this.win.getViewPaneSize(),this.winTopScroll=this.winTop.getScrollPosition(),this.winTopPane=this.winTop.getViewPaneSize(),this.inline?this.rect=this.editable.getClientRect():this.rect=this.frame.getClientRect()}};var u={left:1,right:1,center:1},a={absolute:1,fixed:1};CKEDITOR.plugins.lineutils={finder:e,locator:t,liner:s}})();