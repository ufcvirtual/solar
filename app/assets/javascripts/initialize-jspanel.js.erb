$(function(){

  var countInstanceJsPanel = 0;

  jsPanel.globalCallbacks = function (panel) {
    if (panel.options.paneltype === 'standard') {
      panel.titlebar.addEventListener('dblclick', function () {
        if (panel.status !== 'maximized') {
          panel.maximize();
        } else {
          panel.normalize();
        }
      });
    }

    $("body").on("click",".jsPanel-btn-maximize",function(e){
      panel.maximize();
    });

    $("body").on("click",".jsPanel-btn-minimize",function(e){
      panel.minimize();
    });

    $("body").on("click",".jsPanel-btn-normalize",function(e){
      panel.normalize();
    });

    $("body").on("click",".jsPanel-btn-close",function(e){
      panel.close();
    });
  };

  $("body").on("click",".jspanel",function(e){
    openjspanel(e, countInstanceJsPanel, e.target.href, this.id);
  });
});

function openjspanel(object, countInstanceJsPanel, url, id){
  $('head').append('<meta name="viewport" content="width=device-width, initial-scale=1"/>');
    if(countInstanceJsPanel<3){
      countInstanceJsPanel++;
      object.preventDefault();
      object.target = object.currentTarget;
      var color = $('#mysolar_topbar_wide_background').css('backgroundColor');
      var before_open = false;
      let config = {
          id: id+'_js_panel',
          theme:       color,
          headerTitle: object.target.name,
          headerControls: {
              smallify: 'remove',
          },
          position: 'center-top',
          contentSize: {
              width:  $(window).width() * 0.9,
              height: $(window).height() * 0.85
          },
          contentOverflow: 'hidden',
          content: '<iframe src='+url+' focus="true" style="width: 100%; height: 100%;" tabindex="0"></iframe>',
          closeOnEscape: true,
          onbeforeclose: function(){
            give_focus_to_back_jspanel();
            countInstanceJsPanel--;
            delete_elemente_in_local_storage(id+'_js_panel');
            return true;
          },
          onbeforeminimize: () => {
            restore_focus_to_back_jspanel();
            return true;
          },
          onbeforemaximize: () => {
            restore_focus_from_back_jspanel();
            return true;
          },
          onbeforenormalize: () => {
            restore_focus_from_back_jspanel();
            return true;
          },
          callback: panel => {
            remove_focus_from_back_jspanel();
            add_description_to_buttons_jspanel();
            focus_on_jspanel_element();
            add_events_to_buttons_jspanel(panel);
          }
      };
      if (localStorage.hasOwnProperty("configs")) {
        var configs = JSON.parse(localStorage.getItem("configs"));
      }else{
        var configs = [];
      }
      let currente_allocation_tag = $("#curriculum_unit_selected").text();
      localStorage.setItem('curriculum_unit_selected', currente_allocation_tag);
      configs.forEach(function (config, indice, array) {
        if(id+'_js_panel' == config.id){
          before_open = true;
        }
      });
      if(before_open==false){
        configs.push(config);
        localStorage.setItem('configs', JSON.stringify(configs));
        jsPanel.create(config);
        //save panel layout
        var storedData = jsPanel.layout.save({
          selector: '.jsPanel-standard',
          storagename: 'solar_jspanels'
        });
      }else{
        let paineis = jsPanel.getPanels();
        paineis.forEach(function (panel, indice, array) {
          if(id+'_js_panel' == panel.id){
            panel.normalize();
          }
        });
      }
    } else{
      flash_message("<%=I18n.t('lessons.index.jspanel_count_window') %>", "alert");
      return false;
    }
}
