function edit_comment(button){
  if($(button).attr('disabled') == 'disabled')
    return false;
  $("#new_comment, .edit_comment").attr("disabled", "disabled");
  $($(button).parents(".comment")[0]).hide();
  $.get($(button).data("url"), function(data){
    $($(button).parents("li")[0]).append(data);
  });
  return false;
}

function remove_comment(button){
  var button_table = $($(button).parents("li")[0]);
  if (confirm("<%=I18n.t(:are_you_sure)%>"))
    $.delete($(button).data("url"), function(data){
      if(!!$('.fancybox-outer').length)
        flash_message("<%=I18n.t('comments.success.removed')%>", "notice", 'fancybox-outer');
      else
        flash_message("<%=I18n.t('comments.success.removed')%>", 'notice');
      var parent = button_table.parent();
      button_table.remove();
      update_tables_with_no_data('.comments_list', '.comments_list > li');

      if(data.ac_id != undefined)
        after_evaluate(data.tool, data.score_type, data.ac_id, data.user_id, data, data.group_id);
    }).error(function(data){
      show_error(data);
    });
}

function cancel_new_comment(){
  $(".comment_form").html("");
  $(".new_comment_btns").addClass("invisible");
  $("#new_comment").show();
  $("#new_comment, .edit_comment").removeAttr("disabled");
  return false;
}

function verify_comment_before_finish_evaluation(){

  var content = $('div.ckeditor .cke_contents iframe').contents().find('body').html();
  if (content != undefined && content != "<p><br></p>" && content != "<br>" && content != ""){
      $('textarea.ckeditor').html(content);

      if (confirm("<%=I18n.t('comments.list.comment_finish_evaluation_unsaved')%>")){
          $('#comment_form').serialize_and_submit({
            files: true,
            prepend_to_list: $(".comments_list"),
            dont_remove_lightbox: true,
            outer: 'fancybox-outer',
            complement_success: function(data){
              cancel_new_comment();
              update_tables_with_no_data('.comments_list', '.comments_list > li');
              if(data.ac_id != undefined)
                after_evaluate(data.tool, data.score_type, data.ac_id, data.user_id, data, data.group_id);
              if(!!$('.fancybox-outer').length)
                flash_message("#{t('comments.success.new')}", "notice", 'fancybox-outer');
              else
                flash_message("#{t('comments.success.new')}", "notice");
            }
          });
      }
  }
}